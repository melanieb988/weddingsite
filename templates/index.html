{% extends 'layout.html' %}

{% block body %}
<div class="page-wrapper">

  <div class="page-grid">

    <!-- LEFT: COLLAGE -->
    <div class="collage-wrapper four-img">
      <!-- Images injected dynamically via JS -->
    </div>

    <!-- RIGHT: INVITATION CONTENT -->
    <div class="invitation-content">
      <p class="save-the-date">
        Save the Date
        
      </p>

      <h1 class="names">
        Melanie Bowden<br>
        <span class="ampersand">&amp;</span><br>
        Isaac Birocci
      </h1>
      <span class="logo-inline">
        <img src="{{ url_for('static', filename='images/biltmore1.png') }}" alt="Venue logo">
      </span>
      <p class="date">October 24, 2026</p>
      <p class="location">Atlanta, Georgia</p>

      <button class="rsvp-btn" data-bs-toggle="modal" data-bs-target="#rsvpModal">
        RSVP
      </button>
    </div>

  </div>
</div>

<!-- RSVP MODAL -->
<div class="modal fade" id="rsvpModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">RSVP</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="text" id="guestName" class="form-control mb-3" placeholder="Enter your name">
        <button id="searchBtn" class="btn btn-outline-dark mb-3">Find My Invitation</button>
        <div id="householdContainer"></div>
      </div>

      <div class="modal-footer">
        <button id="submitRsvpBtn" class="btn btn-dark">Submit RSVP</button>
      </div>
    </div>
  </div>
</div>

<!-- ---------------------- -->
<!-- STYLES -->
<!-- ---------------------- -->
<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: #faf9f7;
  font-family: 'Montserrat', sans-serif;
}

.page-wrapper {
  width: 100vw;
  height: 100vh;
}

.page-grid {
  display: grid;
  grid-template-columns: 1.1fr 0.9fr;
  width: 100%;
  height: 100%;
}

/* COLLAGE */
.collage-wrapper {
  position: relative;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

.collage-photo {
  position: absolute;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  transition: all 0.6s ease;
  width: auto;
  height: auto;
  max-width: 100%;
  max-height: 100%;
  object-fit: cover;
}

/* DESKTOP LAYOUTS */
.four-img .slot-1 { top:5%; left:5%; max-width:48%; max-height:48%; }
.four-img .slot-2 { top:5%; left:50%; max-width:48%; max-height:48%; }
.four-img .slot-3 { top:43%; left:5%; max-width:48%; max-height:48%; }
.four-img .slot-4 { top:40%; left:50%; max-width:48%; max-height:48%; }

.three-img .slot-1 { top:5%; left:5%; max-width:50%; max-height:60%; }
.three-img .slot-2 { top:5%; left:45%; max-width:60%; max-height:40%; }
.three-img .slot-3 { top:35%; left:45%; max-width:60%; max-height:40%; }

.two-img .slot-1 { top:10%; left:10%; max-width:45%; max-height:45%; }
.two-img .slot-2 { top:10%; left:50%; max-width:45%; max-height:45%; }

/* INVITATION RIGHT */
.invitation-content {
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  padding: 16px;
  text-align: center;
  margin-top:10px;
}

.save-the-date {
    font-family:'Great Vibes', cursive; 
    font-size:4rem; 
    color:#2d2f3f;
}
.logo-inline img {
  height: 74px;
  margin: 0 15px;
  vertical-align: middle;
  opacity: 0.8;
  margin-bottom:16px;
}

.names {
  font-family: 'serif';
  font-size: 3rem;
  color: #514131;
  line-height: 1.1;
  margin-bottom: 16px;
}

.ampersand {
  color: #8a685d;
  font-size: 2.2rem;
}

.date {
  font-family: 'Montserrat', sans-serif;
  letter-spacing: 0.18em;
  color: #514131;
  margin-bottom: 4px;
}

.location {
  font-family: 'Montserrat', sans-serif;
  color: #2d2f3f;
  margin-bottom: 24px;
}

.rsvp-btn {
  background: transparent;
  border: 1px solid #514131;
  color: #514131;
  padding: 12px 36px;
  letter-spacing: 0.14em;
  transition: all 0.3s ease;
}

.rsvp-btn:hover {
  background: #514131;
  color: #faf9f7;
}

/* ----------------- */
/* MOBILE LAYOUT */
/* ----------------- */
@media (max-width: 768px) {
  .page-grid {
    grid-template-columns: 1fr;
  }

  .collage-wrapper {
    height: 400px; /* adjust height for mobile */
  }

  .collage-photo {
    position: absolute !important;
    width: auto;
    height: auto;
    max-width: 100%;
    max-height: 100%;
    transform: rotate(0deg) !important;
  }

  /* Mobile 3-image layout — fully editable */
  .three-img .slot-1 { top:5%; left:5%; max-width:60%; max-height:60%; }
  .three-img .slot-2 { top:5%; left:45%; max-width:45%; max-height:55%; }
  .three-img .slot-3 { top:50%; left:35%; max-width:55%; max-height:55%; }

  .two-img .slot-1 { top:10%; left:10%; max-width:45%; max-height:45%; }
  .two-img .slot-2 { top:50%; left:50%; max-width:45%; max-height:45%; }
}
</style>

<!-- ---------------------- -->
<!-- ROTATING COLLAGE JS -->
<!-- ---------------------- -->
<script>
const rotations = [
  { type: 'four-img', images: ['grun.JPG','liftsnow.jpg','guatamaladock.jpg','banff.jpg'] },
  { type: 'three-img', images: ['dipsea.jpg','parents.jpg','bike.jpg'] },
  { type: 'four-img', images: ['party.jpg','ski.jpg','guatamalastreet.jpg','hbike.JPG'] },
  { type: 'three-img', images: ['banffrun.jpg','ggp.jpg','trun.jpg'] },
  { type: 'two-img', images: ['trun.JPG','liftsnow.jpg'] }
];

// Mobile-specific rotations (choose manually)
const mobileRotations = [
  { type: 'three-img', images: ['grun.JPG','liftsnow.jpg','guatamaladock.jpg'] },
  { type: 'three-img', images: ['dipsea.jpg','parents.jpg','bike.jpg'] },
  { type: 'three-img', images: ['guatamalastreet.jpg','party.jpg','ski.jpg'] },
  { type: 'three-img', images: ['banffrun.jpg','ggp.jpg','trun.jpg'] },
];

let currentRotation = 0;
const collageWrapper = document.querySelector('.collage-wrapper');

function showRotation(rotation) {
  collageWrapper.className = 'collage-wrapper ' + rotation.type;
  collageWrapper.innerHTML = '';

  let imagesToShow = rotation.images;

  if (window.innerWidth <= 768) {
    // pick 3 images for mobile
    imagesToShow = mobileRotations[currentRotation % mobileRotations.length].images;
  }

  imagesToShow.forEach((imgName, idx) => {
    const img = document.createElement('img');
    img.src = `/static/images/collage/${imgName}`;
    img.className = 'collage-photo slot-' + (idx + 1);

    // rotate only on desktop
    if (window.innerWidth > 768) {
      const angle = Math.random() * 16 - 8;
      img.style.transform = `rotate(${angle}deg)`;
      const xShift = Math.random() * 10 - 5;
      const yShift = Math.random() * 10 - 5;
      img.style.top = `calc(${img.style.top} + ${yShift}px)`;
      img.style.left = `calc(${img.style.left} + ${xShift}px)`;
    }

    collageWrapper.appendChild(img);
  });
}

// Initial load
showRotation(rotations[currentRotation]);

// Rotate every 6 seconds
setInterval(() => {
  currentRotation = (currentRotation + 1) % rotations.length;
  showRotation(rotations[currentRotation]);
}, 4000);

// Update layout on resize
window.addEventListener('resize', () => {
  showRotation(rotations[currentRotation]);
});
</script>




<script>
const container = document.getElementById("householdContainer");

/* SEARCH BUTTON */
document.getElementById("searchBtn").addEventListener("click", async () => {
    const name = document.getElementById("guestName").value.trim();
    if (!name) return alert("Please enter your name.");

    container.innerHTML = "<p>Searching...</p>";

    const res = await fetch("/api/lookup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name })
    });

    const matches = await res.json();
    container.innerHTML = "";

    if (!matches.length) {
        container.innerHTML = "<p>No invitation found. Please check spelling.</p>";
        return;
    }

    // Single match → load household
    if (matches.length === 1) {
        loadHousehold(matches[0]);
        return;
    }

    // Multiple matches → user selects which one they are
    container.innerHTML = "<p class='fw-bold'>Multiple matches found. Which one are you?</p>";
    matches.forEach(m => {
        const btn = document.createElement("button");
        btn.className = "btn btn-outline-primary w-100 mb-2";
        btn.innerText = `${m.name} (${m.household_id})`;
        btn.onclick = () => loadHousehold(m);
        container.appendChild(btn);
    });
});

/* LOAD HOUSEHOLD MEMBERS */
async function loadHousehold(selectedPerson) {
    container.innerHTML = "<p>Loading your household...</p>";

    const res = await fetch("/api/household", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ household_id: selectedPerson.household_id })
    });

    const guests = await res.json();
    renderHousehold(guests);
}

/* RENDER HOUSEHOLD FORM */
function renderHousehold(guests) {
    container.innerHTML = "";

    guests.forEach(g => {
        const div = document.createElement("div");
        div.className = "border rounded p-3 mb-3";

        const plusOneHTML = g.plus_one_allowed ? `
            <label class="form-label mt-2">Bringing a plus one?</label>
            <select class="form-select plus-one-toggle">
                <option value="no" ${!g.plus_one_name ? "selected" : ""}>No</option>
                <option value="yes" ${g.plus_one_name ? "selected" : ""}>Yes</option>
            </select>
            <input class="form-control mt-2 plus-one-name"
                   placeholder="Plus One Name"
                   value="${g.plus_one_name || ""}"
                   style="display:${g.plus_one_name ? "block" : "none"}">
        ` : "";

        div.innerHTML = `
            <div class="form-check">
                <input class="form-check-input attending" type="checkbox" ${g.attending ? "checked" : ""}>
                <label class="form-check-label fw-bold">${g.name}</label>
            </div>

            <input class="form-control mt-2 meal"
                   placeholder="Meal choice"
                   value="${g.meal_choice || ""}">

            ${plusOneHTML}

            <input class="form-control mt-2 song"
                   placeholder="Song request"
                   value="${g.song_rec || ""}">
        `;

        container.appendChild(div);
    });
}

/* TOGGLE PLUS ONE NAME FIELD */
document.addEventListener("change", e => {
    if (e.target.classList.contains("plus-one-toggle")) {
        const input = e.target.nextElementSibling;
        if (e.target.value === "yes") {
            input.style.display = "block";
        } else {
            input.style.display = "none";
            input.value = "";
        }
    }
});

/* SUBMIT RSVP */
document.getElementById("submitRsvpBtn").addEventListener("click", async () => {
    const cards = document.querySelectorAll("#householdContainer > div");
    if (!cards.length) return alert("Please select your invitation first.");

    const guests = [];
    cards.forEach(card => {
        guests.push({
            name: card.querySelector(".form-check-label").innerText,
            attending: card.querySelector(".attending").checked,
            meal_choice: card.querySelector(".meal").value,
            plus_one_name: card.querySelector(".plus-one-name")
                ? card.querySelector(".plus-one-name").value
                : null,
            song_rec: card.querySelector(".song").value
        });
    });

    const res = await fetch("/api/rsvp", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ guests })
    });

    const result = await res.json();
    if (result.status === "success") {
        alert("Thank you! Your RSVP has been recorded.");
        bootstrap.Modal.getInstance(document.getElementById("rsvpModal")).hide();
        container.innerHTML = "";
        document.getElementById("guestName").value = "";
    } else {
        alert("There was an error. Please try again.");
    }
});
</script>
{% endblock %}


