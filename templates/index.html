{% extends 'layout.html' %}

{% block body %}
<div class="page-wrapper">

  <div class="page-grid">

    <!-- LEFT: COLLAGE -->
    <div class="collage-wrapper four-img">
      <!-- Images injected dynamically via JS -->
    </div>

    <!-- RIGHT: INVITATION CONTENT -->
    <div class="invitation-content">
      <p class="save-the-date">
        Save the Date
        
      </p>

      <h1 class="names">
        Melanie Bowden<br>
        <span class="ampersand">&amp;</span><br>
        Isaac Birocci
      </h1>
      <span class="logo-inline">
        <img src="{{ url_for('static', filename='images/biltmore1.png') }}" alt="Venue logo">
      </span>
      <p class="date">October 24, 2026</p>
      <p class="location">Atlanta, Georgia</p>

      <button class="rsvp-btn" data-bs-toggle="modal" data-bs-target="#rsvpModal">
        RSVP
      </button>
    </div>

  </div>
</div>

<!-- RSVP MODAL -->
<div class="modal fade" id="rsvpModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">RSVP</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="text" id="guestName" class="form-control mb-3" placeholder="Enter your first name">
        <button id="searchBtn" class="btn btn-outline-dark mb-3">Find My Invitation</button>
        <div id="householdContainer"></div>
      </div>

      <div class="modal-footer">
        <button id="submitRsvpBtn" class="btn btn-dark">Submit RSVP </button>
      </div>
    </div>
  </div>
</div>
<style>
    /* ========================= */
    /* BASE RESET */
    /* ========================= */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      /* height: 100%; */
      background: #faf9f7;
      font-family: 'Montserrat', sans-serif;
    }
    
    .page-wrapper {
      width: 100%;
      /* height: 100vh; */
    }
    
    .page-grid {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      width: 100%;
      /* height: 100%; */
    }
    
    /* ========================= */
    /* COLLAGE SYSTEM */
    /* ========================= */
    .collage-wrapper {
      position: relative;
      width: 100%;
      aspect-ratio: 4 / 3; /* overridden per rotation */
      overflow: hidden;
      background: #faf9f7;
      max-height:90vh;
    }
    
    /* All images fill their boxes */
    .collage-photo {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
    
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    
      transition:
        top 0.6s ease,
        left 0.6s ease,
        width 0.6s ease,
        height 0.6s ease,
        transform 0.6s ease,
        opacity 0.6s ease;
    }
    
    /* ========================= */
    /* INVITATION CONTENT */
    /* ========================= */
    .invitation-content {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding: 16px;
      text-align: center;
      margin-top: 10px;
    }
    
    .save-the-date {
      font-family: 'Great Vibes', cursive;
      font-size: 4rem;
      color: rgb(46, 90, 89);
    }
    
    .logo-inline img {
      height: 125px;
      margin: 0 15px 16px;
      vertical-align: middle;
      opacity: 0.8;
    }
    
    .names {
      font-family: serif;
      font-size: 2rem;
      color: #514131;
      line-height: 1.1;
      margin-bottom: 16px;
    }
    
    .ampersand {
      color: #514131;
      font-size: 2rem;
    }
    
    .date {
      font-family: 'Montserrat', sans-serif;
      letter-spacing: 0.18em;
      color: rgb(46, 90, 89);
      margin-bottom: 4px;
    }
    
    .location {
      font-family: 'Montserrat', sans-serif;
      color: rgb(46, 90, 89);
      margin-bottom: 24px;
    }
    
    .rsvp-btn {
      background: transparent;
      border: 1px solid #514131;
      color: #514131;
      padding: 12px 36px;
      letter-spacing: 0.14em;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .rsvp-btn:hover {
      background: #514131;
      color: #faf9f7;
    }
    
    /* ========================= */
    /* MOBILE */
    /* ========================= */
    @media (max-width: 768px) {
      html, body {
        height: auto;
      }
    
      .page-grid {
        grid-template-columns: 1fr;
        height: auto;
      }
    
      .collage-wrapper {
        width: 100vw;
        max-height:55vh;
        margin-left:-0.5rem;
        margin-right:-0.5rem;
      }
    
      .collage-photo {
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.14);
      }
          .collage-wrapper::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 25px;
    pointer-events: none;

    background: linear-gradient(
      to bottom,
      rgba(250,249,247,0) 0%,
      #faf9f7 100%
    );
  }
    }
    </style>
    
<!-- ---------------------- -->
<!-- ROTATING COLLAGE JS -->
<!-- ---------------------- -->
<script>
    const wrapper = document.querySelector('.collage-wrapper');
    let current = 0;
  
    const isMobile = () => window.innerWidth <= 768;
  
    /* ========================= */
    /* DESKTOP ROTATIONS */
    /* ========================= */
    const DESKTOP_ROTATIONS = [
      {
        aspectRatio: '4 / 3',
        images: [
        'banff.jpg',
        
        'liftsnow.jpg',
        'grun.JPG',
        'parents.jpg'
        ],
        layout: [
          { top: 0,  left: 0,  width: 50, height: 50 },
          { top: 0,  left: 50, width: 50, height: 50 },
          { top: 50, left: 0,  width: 50, height: 50 },
          { top: 50, left: 50, width: 50, height: 50 }
        ],
        rotate: [-2, 2]
      },
      {
        aspectRatio: '4 / 5',
        images: [
          'banffrun.jpg',
          'ggp.jpg',
          'proposal.jpg'
          
        ],
        layout: [
          { top: 0,  left: 0, width: 55, height: 100 },
          { top: 0,  left: 50,  width: 55, height: 50 },
          { top: 50, left: 50,  width: 50, height: 50 }
        ],
        rotate: [-1.5, 1.5]
      },
      {
        aspectRatio: '3 / 4',
        images: [
        'colluseum.JPG',
          'party.jpg',
          'bike.jpg'
          
        ],
        layout: [
          { top: 0,  left: 0,  width: 48, height: 100 },
          { top: 0,  left: 45, width: 55, height: 50 },
          { top: 50, left: 45, width: 55, height: 50 }
        ],
        rotate: [-1.5, 1.5]
      },
      {
        aspectRatio: '3 / 4',
        images: [
        'dipsea.jpg',
          'ski.jpg',
          'guatamalastreet.jpg'
        ],
        layout: [
          { top: 0,  left: 50, width: 50, height: 100 },
          { top: 0,  left: 0,  width: 52, height: 50 },
          { top: 50, left: 0,  width: 52, height: 50 }
        ],
        rotate: [-1.5, 1.5]
      }
    ];
  
    /* ========================= */
    /* MOBILE ROTATIONS */
    /* ========================= */
    const MOBILE_ROTATIONS = [
      {
        aspectRatio: '1 / 1',
        images: [
        'banff.jpg',
        
          'liftsnow.jpg',
          'grun.JPG',
          'parents.jpg'
        ],
        layout: [
          { top: 0,  left: 0,  width: 50, height: 65 },
          { top: 0,  left: 50, width: 50, height: 50 },
          { top: 62, left: 0,  width: 50, height: 40 },
          { top: 50, left: 50, width: 50, height: 50 }
        ],
        rotate: [-1, 1]
      },
      {
        aspectRatio: '4 / 5',
        images: [
          'dipsea.jpg',
          'ski.jpg',
          'guatamalastreet.jpg'
        ],
        layout: [
          { top: 0,  left: 45, width: 55, height: 100 },
          { top: 0,  left: 0,  width: 46, height: 50 },
          { top: 50, left: 0,  width: 46, height: 50 }
        ],
        rotate: [-1, 1]
      },
      {
        aspectRatio: '4 / 5',
        images: [
          'colluseum.JPG',
          'party.jpg',
          'bike.jpg'
          
          
        ],
        layout: [
          { top: 0,  left: 45, width: 55, height: 100 },
          { top: 0,  left: 0,  width: 55, height: 50 },
          { top: 50, left: 0,  width: 46, height: 50 }
        ],
        rotate: [-1, 1]
      },
      
      {
        aspectRatio: '4 / 5',
        images: [
          'banffrun.jpg',
          'ggp.jpg',
          'proposal.jpg'
          
        ],
        layout: [
          { top: 0,  left: 0, width: 55, height: 100 },
          { top: 0,  left: 50,  width: 55, height: 50 },
          { top: 50, left: 50,  width: 50, height: 50 }
        ],
        rotate: [-1, 1]
      },    {
        aspectRatio: '4 / 5',
        images: [
          'guatamaladock.jpg',
          'trun.JPG',
          'brun.HEIC'
        ],
        layout: [
          { top: 0,  left: 45, width: 55, height: 100 },
          { top: 0,  left: 0,  width: 55, height: 50 },
          { top: 48, left: 0,  width: 46, height: 55 }
        ],
        rotate: [-1, 1]
      },
      {
        aspectRatio: '1 / 1',
        images: [
        'bballgame.jpeg',
        
          'hbike.JPG',
          'italybike.jpeg',
          'yellowstone.JPG'
        ],
        layout: [
          { top: 0,  left: 0,  width: 50, height: 60 },
          { top: 0,  left: 50, width: 50, height: 50 },
          { top: 60, left: 0,  width: 50, height: 40 },
          { top: 50, left: 50, width: 50, height: 50 }
        ],
        rotate: [-1, 1]
      },
    ];
  
    /* ========================= */
    /* RENDER */
    /* ========================= */
    function renderRotation() {
      const rotations = isMobile() ? MOBILE_ROTATIONS : DESKTOP_ROTATIONS;
      const rotation = rotations[current % rotations.length];
  
      wrapper.innerHTML = '';
      wrapper.style.aspectRatio = rotation.aspectRatio;
  
      rotation.images.forEach((src, i) => {
        const img = document.createElement('img');
        img.src = `/static/images/collage/${src}`;
        img.className = 'collage-photo';
  
        const { top, left, width, height } = rotation.layout[i];
        img.style.top = `${top}%`;
        img.style.left = `${left}%`;
        img.style.width = `${width}%`;
        img.style.height = `${height}%`;
  
        const [minR, maxR] = rotation.rotate;
        const angle = minR + Math.random() * (maxR - minR);
        img.style.transform = `rotate(${angle}deg)`;
  
        wrapper.appendChild(img);
      });
    }
  
    /* ========================= */
    /* INIT */
    /* ========================= */
    renderRotation();
  
    /* ========================= */
    /* ROTATE */
    /* ========================= */
    setInterval(() => {
      current++;
      renderRotation();
    }, 4000);
  
    /* ========================= */
    /* RESIZE */
    /* ========================= */
    window.addEventListener('resize', () => {
      current = 0; // optional: reset to avoid weird jumps
      renderRotation();
    });
  </script>
  
  <script>
    const guestNameInput = document.getElementById("guestName");
    const searchBtn = document.getElementById("searchBtn");

// Trigger search on Enter key
    guestNameInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
        e.preventDefault();  // prevent form submission / page reload
        searchBtn.click();   // trigger the existing click event
    }
});
    const container = document.getElementById("householdContainer");
    
    // CONFIG: toggle fields on/off easily
    const FIELD_CONFIG = {
        attending: true,
        meal_choice: true,
        dietary_restriction: false,
        plus_one_name: true,
        song_rec: true
    };
    
    /* SEARCH BUTTON */
    document.getElementById("searchBtn").addEventListener("click", async () => {
        const name = document.getElementById("guestName").value.trim();
        if (!name) return alert("Please enter your first name.");
    
        container.innerHTML = "<p>Searching...</p>";
    
        const res = await fetch("/api/lookup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name })
        });
    
        const matches = await res.json();
        container.innerHTML = "";
    
        if (!matches.length) {
            container.innerHTML = "<p>No invitation found. Please check spelling.</p>";
            return;
        }
    
        if (matches.length === 1) {
            loadHousehold(matches[0]);
            return;
        }
    
        container.innerHTML = "<p class='fw-bold'>Multiple matches found. Which one are you?</p>";
        matches.forEach(m => {
            const btn = document.createElement("button");
            btn.className = "btn btn-outline-primary w-100 mb-2";
            btn.innerText = `${m.name} (${m.household_id})`;
            btn.onclick = () => loadHousehold(m);
            container.appendChild(btn);
        });
    });
    
    /* LOAD HOUSEHOLD MEMBERS */
    async function loadHousehold(selectedPerson) {
        container.innerHTML = "<p>Loading your household...</p>";
    
        const res = await fetch("/api/household", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ household_id: selectedPerson.household_id })
        });
    
        const guests = await res.json();
        renderHousehold(guests);
    }
    
    /* RENDER HOUSEHOLD FORM */
    function renderHousehold(guests) {
        container.innerHTML = "";
    
        guests.forEach(g => {
            const div = document.createElement("div");
            div.className = "border rounded p-3 mb-3";
            div.dataset.guestId = g.guest_id;
    
            let html = `
            <div class="fw-bold mb-2">${g.name}</div>
        `;
            
            // ATTENDING / NOT ATTENDING radio buttons
            if (FIELD_CONFIG.attending) {
            let attendingYesChecked = "";
            let attendingNoChecked = "";

            if (g.attending === true || g.attending === "t") {
                attendingYesChecked = "checked";
            } else if (g.attending === false || g.attending === "f") {
                attendingNoChecked = "checked";
            } else {
                attendingYesChecked = "checked";
            }

            html += `
            <div class="form-check form-check-inline">
                <input class="form-check-input attending" type="radio" name="attending-${g.guest_id}" value="true" ${attendingYesChecked}>
                <label class="form-check-label">Attending</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input attending" type="radio" name="attending-${g.guest_id}" value="false" ${attendingNoChecked}>
                <label class="form-check-label">Not Attending</label>
            </div>
            `;
        }
    
            // MEAL CHOICE
            if (FIELD_CONFIG.meal_choice) {
                html += `
                <input class="form-control mt-2 meal"
                      placeholder="Meal selection â€” check back later"
                      value="${g.meal_choice || ""}"
                      readonly
                      style="background-color:#e9ecef; cursor:not-allowed;">
                `;
            }
    
            // DIETARY RESTRICTION
            if (FIELD_CONFIG.dietary_restriction) {
                html += `
                <input class="form-control mt-2 dietary_restriction"
                       placeholder="Dietary restriction"
                       value="${g.dietary_restriction || ""}">
                `;
            }
    
            // PLUS ONE NAME
            if (FIELD_CONFIG.plus_one_name && g.plus_one_allowed) {
                html += `
                <label class="form-label mt-2">Bringing a plus one?</label>
                <select class="form-select plus-one-toggle">
                    <option value="no" ${!g.plus_one_name ? "selected" : ""}>No</option>
                    <option value="yes" ${g.plus_one_name ? "selected" : ""}>Yes</option>
                </select>
                <input class="form-control mt-2 plus-one-name"
                       placeholder="Plus One Name"
                       value="${g.plus_one_name || ""}"
                       style="display:${g.plus_one_name ? "block" : "none"}">
                `;
            }
    
            // SONG REQUEST
            if (FIELD_CONFIG.song_rec) {
                html += `
                <input class="form-control mt-2 song"
                       placeholder="Song request"
                       value="${g.song_rec || ""}">
                `;
            }
    
            div.innerHTML = html;
            container.appendChild(div);
        });
    }
    
    /* TOGGLE PLUS ONE NAME FIELD */
    document.addEventListener("change", e => {
        if (e.target.classList.contains("plus-one-toggle")) {
            const input = e.target.nextElementSibling;
            if (e.target.value === "yes") {
                input.style.display = "block";
            } else {
                input.style.display = "none";
                input.value = "";
            }
        }
    });
    
    /* SUBMIT RSVP */
    document.getElementById("submitRsvpBtn").addEventListener("click", async () => {
        const cards = document.querySelectorAll("#householdContainer > div");
    
        if (!cards.length) {
            alert("Please search for your invitation first.");
            return;
        }
    
        // Collect guest info
        const guests = Array.from(cards).map(card => {
            // Attending boolean
            const attendingRadio = card.querySelector("input[name='attending-" + card.dataset.guestId + "']:checked");
            return {
                guest_id: card.dataset.guestId ? parseInt(card.dataset.guestId) : null,
                attending: attendingRadio ? attendingRadio.value === "true" : null,
                meal_choice: card.querySelector(".meal") ? card.querySelector(".meal").value : null,
                dietary_restriction: card.querySelector(".dietary_restriction") ? card.querySelector(".dietary_restriction").value : null,
                plus_one_name: card.querySelector(".plus-one-name") ? card.querySelector(".plus-one-name").value : null,
                song_rec: card.querySelector(".song") ? card.querySelector(".song").value : null
            };
        });
    
        try {
            const res = await fetch("/api/rsvp", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ guests })
            });
    
            const data = await res.json();
    
            if (data.status === "success") {
                alert("RSVP submitted successfully! Check back later to make meal selection");
    
                // Auto-close modal
                const rsvpModalEl = document.getElementById("rsvpModal");
                const modalInstance = bootstrap.Modal.getInstance(rsvpModalEl) || new bootstrap.Modal(rsvpModalEl);
                modalInstance.hide();
            } else if (data.error) {
                alert(`Error: ${data.error}`);
            } else {
                alert("Unexpected response from server. Check console.");
                console.log(data);
            }
        } catch (err) {
            console.error("Error submitting RSVP:", err);
            alert("There was an error submitting your RSVP. Check the console.");
        }
    });
    </script>
    
{% endblock %}




